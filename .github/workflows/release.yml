name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build:
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Resolve Swift Package Dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -scheme ClaudeIsland \
            -project ClaudeIsland.xcodeproj
            
      - name: Build app
        run: |
          xcodebuild archive \
            -scheme ClaudeIsland \
            -configuration Release \
            -archivePath build/ClaudeIsland.xcarchive \
            -destination "generic/platform=macOS" \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
            
      - name: Export app
        run: |
          mkdir -p build/export
          
          # Create export options plist for unsigned export
          cat > build/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>mac-application</string>
              <key>destination</key>
              <string>export</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>signingCertificate</key>
              <string>-</string>
          </dict>
          </plist>
          EOF
          
          # Copy app from archive (since we're not code signing)
          cp -R "build/ClaudeIsland.xcarchive/Products/Applications/Claude Island.app" build/export/
          
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          
      - name: Install create-dmg
        run: brew install create-dmg
        
      - name: Create DMG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          create-dmg \
            --volname "OpenCode Island" \
            --window-size 600 400 \
            --icon-size 100 \
            --icon "Claude Island.app" 150 200 \
            --app-drop-link 450 200 \
            --hide-extension "Claude Island.app" \
            "OpenCodeIsland-${VERSION}.dmg" \
            "build/export/Claude Island.app" || true
            
          # Fallback to hdiutil if create-dmg fails
          if [ ! -f "OpenCodeIsland-${VERSION}.dmg" ]; then
            echo "create-dmg failed, using hdiutil..."
            hdiutil create -volname "OpenCode Island" \
              -srcfolder "build/export/Claude Island.app" \
              -ov -format UDZO \
              "OpenCodeIsland-${VERSION}.dmg"
          fi
          
          ls -la *.dmg
          
      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCodeIsland-${{ steps.version.outputs.version }}
          path: OpenCodeIsland-${{ steps.version.outputs.version }}.dmg
          
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: OpenCodeIsland-${{ steps.version.outputs.version }}.dmg
          name: OpenCode Island v${{ steps.version.outputs.version }}
          body: |
            ## OpenCode Island v${{ steps.version.outputs.version }}
            
            ### Installation
            1. Download `OpenCodeIsland-${{ steps.version.outputs.version }}.dmg`
            2. Open the DMG and drag OpenCode Island to Applications
            3. Launch OpenCode Island from Applications
            
            > **Note:** This build is unsigned. On first launch, right-click the app and select "Open" to bypass Gatekeeper, or go to System Preferences > Security & Privacy to allow it.
            
            ### Requirements
            - macOS 15.0+
            - [OpenCode CLI](https://opencode.ai) installed and configured
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
